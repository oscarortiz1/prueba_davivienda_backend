{
  "rules": {
    ".read": false,
    ".write": false,
    
    "users": {
      "$userId": {
        ".read": "auth != null",
        ".write": "auth != null && auth.uid == $userId",
        ".validate": "newData.hasChildren(['id', 'name', 'email', 'password', 'createdAt', 'updatedAt'])",
        "id": {
          ".validate": "newData.isString() && newData.val() == $userId"
        },
        "name": {
          ".validate": "newData.isString() && newData.val().length > 0"
        },
        "email": {
          ".validate": "newData.isString() && newData.val().matches(/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,}$/i)"
        },
        "password": {
          ".validate": "newData.isString()"
        },
        "createdAt": {
          ".validate": "newData.isString()"
        },
        "updatedAt": {
          ".validate": "newData.isString()"
        }
      }
    },
    
    "surveys": {
      ".indexOn": ["createdBy"],
      "$surveyId": {
        ".read": "auth != null && (data.child('isPublished').val() == true || data.child('createdBy').val() == auth.uid)",
        ".write": "auth != null && (
          (!data.exists() && newData.child('createdBy').val() == auth.uid) ||
          (data.exists() && data.child('createdBy').val() == auth.uid)
        )",
        ".validate": "newData.hasChildren(['id', 'title', 'description', 'createdBy', 'createdAt', 'updatedAt', 'isPublished'])",
        "id": {
          ".validate": "newData.isString() && newData.val() == $surveyId"
        },
        "title": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 200"
        },
        "description": {
          ".validate": "newData.isString() && newData.val().length <= 1000"
        },
        "createdBy": {
          ".validate": "newData.isString() && (!data.exists() || data.val() == newData.val())"
        },
        "createdAt": {
          ".validate": "newData.isString()"
        },
        "updatedAt": {
          ".validate": "newData.isString()"
        },
        "isPublished": {
          ".validate": "newData.isBoolean()"
        },
        "questions": {
          ".validate": "newData.hasChildren()"
        }
      }
    },
    
    "surveyResponses": {
      ".indexOn": ["userId", "surveyId"],
      "$responseId": {
        ".read": "auth != null && (data.child('userId').val() == auth.uid || root.child('surveys').child(data.child('surveyId').val()).child('createdBy').val() == auth.uid)",
        ".write": "auth != null && (
          (!data.exists() && newData.child('userId').val() == auth.uid && root.child('surveys').child(newData.child('surveyId').val()).child('isPublished').val() == true) ||
          (data.exists() && data.child('userId').val() == auth.uid && !newData.exists())
        )",
        "userId": {
          ".validate": "newData.isString() && newData.val() == auth.uid"
        },
        "surveyId": {
          ".validate": "newData.isString() && root.child('surveys').child(newData.val()).exists()"
        }
      }
    }
  }
}
